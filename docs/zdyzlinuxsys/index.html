<!doctype html>
<html lang="zh-CN" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-skill/Linux/zdyzlinuxsys">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.4.0">
<title data-rh="true">I.MX6U学习笔记系统移植篇 - pansyhou的小站</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://pansyhou.github.io/img/logo.png"><meta data-rh="true" name="twitter:image" content="https://pansyhou.github.io/img/logo.png"><meta data-rh="true" property="og:url" content="https://pansyhou.github.io/docs/zdyzlinuxsys"><meta data-rh="true" name="docusaurus_locale" content="zh-CN"><meta data-rh="true" name="docsearch:language" content="zh-CN"><meta data-rh="true" name="keywords" content="pansyhou"><meta data-rh="true" name="keywords" content="blog, javascript, typescript, node, react, vue, web"><meta data-rh="true" name="keywords" content="编程爱好者, Web开发者, 写过爬虫, 学过逆向，现在主攻ts全栈"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="I.MX6U学习笔记系统移植篇 - pansyhou的小站"><meta data-rh="true" name="description" content="WTF is Uboot"><meta data-rh="true" property="og:description" content="WTF is Uboot"><link data-rh="true" rel="icon" href="/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://pansyhou.github.io/docs/zdyzlinuxsys"><link data-rh="true" rel="alternate" href="https://pansyhou.github.io/docs/zdyzlinuxsys" hreflang="zh-CN"><link data-rh="true" rel="alternate" href="https://pansyhou.github.io/docs/zdyzlinuxsys" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://GV6YN1ODMO-dsn.algolia.net" crossorigin="anonymous"><link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-S4SD5NXWXF"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-S4SD5NXWXF",{anonymize_ip:!0})</script>


<link rel="search" type="application/opensearchdescription+xml" title="pansyhou的小站" href="/opensearch.xml">
<link rel="preconnect" href="https://matomo.kuizuo.cn/">
<script>var _paq=window._paq=window._paq||[];_paq.push(["setRequestMethod","POST"]),_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),_paq.push(["enableHeartBeatTimer"]),function(){var e="https://matomo.kuizuo.cn/";_paq.push(["setRequestMethod","POST"]),_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","1"]);var a=document,t=a.createElement("script"),p=a.getElementsByTagName("script")[0];t.type="text/javascript",t.async=!0,t.src=e+"matomo.js",p.parentNode.insertBefore(t,p)}()</script>


<script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?c9a3849aa75f9c4a4e65f846cd1a5155",e.defer=!0;var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
<meta name="baidu-site-verification" content="code-rqLUw5reVS">
<script>!function(){var t=document.createElement("script"),e=window.location.protocol.split(":")[0];t.src="https"===e?"https://zz.bdstatic.com/linksubmit/push.js":"http://push.zhanzhang.baidu.com/push.js",t.defer=!0;var s=document.getElementsByTagName("script")[0];s.parentNode.insertBefore(t,s)}()</script>
<link rel="alternate" type="application/rss+xml" href="/rss.xml" title="pansyhou RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/atom.xml" title="pansyhou Atom Feed">
<link rel="alternate" type="application/json" href="/feed.json" title="pansyhou JSON Feed">

<link rel="icon" href="/img/logo.png">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="rgb(51 139 255)">
<meta name="description" content="pansyhou的个人博客">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.15.2/dist/katex.min.css" integrity="sha384-MlJdn/WNKDGXveldHDdyRP1R4CTHr3FeuDNfhsLPYrq2t0UBkUdK2jyTnXPEK1NQ" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.4d5ec00a.css">
<link rel="preload" href="/assets/js/runtime~main.b6668888.js" as="script">
<link rel="preload" href="/assets/js/main.0bce34a8.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(e){}return e}()||function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):window.matchMedia("(prefers-color-scheme: light)").matches?e("light"):e("dark")}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">跳到主要内容</a></div><nav aria-label="主导航" class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="切换导航栏" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.webp" alt="pansyhou" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.webp" alt="pansyhou" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">pansyhou</b></a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">学习</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/skill/">笔记</a></li><li><a class="dropdown__link" href="/docs/oi/">刷题</a></li><li><a class="dropdown__link" href="/tags">标签</a></li><li><a class="dropdown__link" href="/archive">归档</a></li><li><a class="dropdown__link" href="/docs/english/">英语</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">嵌入式开发</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/stm32/">STM32</a></li><li><a class="dropdown__link" href="/docs/ros/">ROS</a></li><li><a class="dropdown__link" href="/docs/Android/">Android</a></li></ul></div><a class="navbar__item navbar__link" href="/resource">导航</a><a class="navbar__item navbar__link" href="/project">项目</a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link"><svg viewBox="0 0 24 24" width="20" height="20" aria-hidden="true" class="iconLanguage_nlXk"><path fill="currentColor" d="M12.87 15.07l-2.54-2.51.03-.03c1.74-1.94 2.98-4.17 3.71-6.53H17V4h-7V2H8v2H1v1.99h11.17C11.5 7.92 10.44 9.75 9 11.35 8.07 10.32 7.3 9.19 6.69 8h-2c.73 1.63 1.73 3.17 2.98 4.56l-5.09 5.02L4 19l5-5 3.11 3.11.76-2.04zM18.5 10h-2L12 22h2l1.12-3h4.75L21 22h2l-4.5-12zm-2.62 7l1.62-4.33L19.12 17h-3.24z"></path></svg>中文（中国）</a><ul class="dropdown__menu"><li><a href="/docs/zdyzlinuxsys" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" lang="zh-CN">中文（中国）</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为暗黑模式）" aria-label="切换浅色/暗黑模式（当前为暗黑模式）" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="搜索"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">搜索</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a tabindex="-1" class="sidebarLogo_isFc" href="/"><img src="/img/logo.webp" alt="pansyhou" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/logo.webp" alt="pansyhou" class="themedImage_ToTc themedImage--dark_i4oU"><b>pansyhou</b></a><nav aria-label="文档侧边栏" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/skill">技术笔记简介</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/docusaurus-guides">Docusaurus 主题魔改</a><button aria-label="打开/收起侧边栏菜单「Docusaurus 主题魔改」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/01-liner-list">Data-Sturcture</a><button aria-label="打开/收起侧边栏菜单「Data-Sturcture」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/OperateSystem-guides">Operating-System</a><button aria-label="打开/收起侧边栏菜单「Operating-System」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs/ComputerOrganization-guides">Computer-Organization</a><button aria-label="打开/收起侧边栏菜单「Computer-Organization」" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/zdyzlinuxarch">Linux</a><button aria-label="打开/收起侧边栏菜单「Linux」" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/man">man</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/njuics2022">njuics2022</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/keyboardSetting">keyboardSetting</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/openwrtnote1">openwrt学习笔记</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zdyzlinuxarch">I.MX6U学习笔记裸机篇</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/zdyzlinuxsys">I.MX6U学习笔记系统移植篇</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/zdyzlinuxsys2">I.MX6U学习笔记系统移植篇2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/arm-driver-dev1">ARM-Linux驱动开发1</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/arm-driver-dev2">ARM-Linux驱动开发2</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/arm-driver-dev3">ARM-Linux驱动开发3</a></li></ul></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/zdyzlinuxarch"><span itemprop="name">Linux</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">I.MX6U学习笔记系统移植篇</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>I.MX6U学习笔记系统移植篇</h1></header><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="wtf-is-uboot">WTF is Uboot<a href="#wtf-is-uboot" class="hash-link" aria-label="WTF is Uboot的直接链接" title="WTF is Uboot的直接链接">​</a></h2><p>一个BootLoader，支持多种架构，类似于裸机编程，启动linux的</p><p>一般有zimage+dtb(设备树)</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="uboot获取">Uboot获取<a href="#uboot获取" class="hash-link" aria-label="Uboot获取的直接链接" title="Uboot获取的直接链接">​</a></h3><ol><li>官网</li><li>SOC厂商比如nxp。st，他们有自己的开发板</li><li>做开发板的厂商，理智派</li></ol><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="uboot编译">Uboot编译<a href="#uboot编译" class="hash-link" aria-label="Uboot编译的直接链接" title="Uboot编译的直接链接">​</a></h3><p>记得设置好ARCH和CORSS_COMPILE</p><p>建议在Makefile里就设置好</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="uboot-makefile讲解">Uboot Makefile讲解<a href="#uboot-makefile讲解" class="hash-link" aria-label="Uboot Makefile讲解的直接链接" title="Uboot Makefile讲解的直接链接">​</a></h3><p>编译后的文件</p><p><img loading="lazy" src="https://pic.imgdb.cn/item/64ca03971ddac507cc037e5e" alt="image-20230802151935178" class="img_ev3q"><img loading="lazy" src="https://pic.imgdb.cn/item/64ca03ae1ddac507cc03b26b" alt="image-20230802152009807" class="img_ev3q"></p><ol><li><p><code>arm</code>文件夹-&gt;cpu架构有关</p><p>​				   -&gt;board-&gt;freescale-&gt; mx6ullevk 这个文件夹来定义我们的板子</p></li><li><p><code>config</code>文件夹  ：mx6ull_14x14_ddr512_emmc_defconfig等等这些默认配置</p></li><li><p><code>.u-boot.xxx.cmd</code>文件</p><p>这玩意有点玄机啊，基本上都是存命令的。比如说.u-boot.bin.cmd （bin）</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">cmd_u</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">boot</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">bin</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> cp u</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">boot</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">nodtb</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">bin</span><span class="token plain"> u</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">boot</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token property-access">bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到cp u-boot-nodtb.bin过来并改名对吧</p><p>那u-boot-nodtb.bin怎么来的？可以看他的_cmd文件<code>.u-boot-nodtb.bin.cmd</code></p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">cmd_u-boot-nodtb.bin </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> arm-linux-gnueabihf-objcopy --gap-fill</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">0xff  -j .text -j .secure_text -j .rodata -j .hash -j .data -j .got -j .got.plt -j .u_boot_list -j .rel.dyn -O binary  u-boot u-boot-nodtb.bin</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>使用  objcopy 将  ELF 格式的  u-boot 文件转换为二进制的  u-boot-nodtb.bin 文件</p><p>之后就是.u-boot.cmd</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">cmd_u-boot </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> arm-linux-gnueabihf-ld.bfd   -pie  --gc-sections -Bstatic -Ttext 0x87800000 -o u-boot -T u-boot.lds arch/arm/cpu/armv7/start.o --start-group  arch/arm/cpu/built-in.o  arch/arm/cpu/armv7/built-in.o  arch/arm/imx-common/built-in.o  arch/arm/lib/built-in.o  board/freescale/common/built-in.o  board/freescale/mx6ullevk/built-in.o  cmd/built-in.o  common/built-in.o  disk/built-in.o  drivers/built-in.o  drivers/dma/built-in.o  drivers/gpio/built-in.o  drivers/i2c/built-in.o  drivers/mmc/built-in.o  drivers/mtd/built-in.o  drivers/mtd/onenand/built-in.o  drivers/mtd/spi/built-in.o  drivers/net/built-in.o  drivers/net/phy/built-in.o  drivers/pci/built-in.o  drivers/power/built-in.o  drivers/power/battery/built-in.o  drivers/power/fuel_gauge/built-in.o  drivers/power/mfd/built-in.o  drivers/power/pmic/built-in.o  drivers/power/regulator/built-in.o  drivers/serial/built-in.o  drivers/spi/built-in.o  drivers/usb/dwc3/built-in.o  drivers/usb/emul/built-in.o  drivers/usb/eth/built-in.o  drivers/usb/gadget/built-in.o  drivers/usb/gadget/udc/built-in.o  drivers/usb/host/built-in.o  drivers/usb/musb-new/built-in.o  drivers/usb/musb/built-in.o  drivers/usb/phy/built-in.o  drivers/usb/ulpi/built-in.o  fs/built-in.o  lib/built-in.o  net/built-in.o  test/built-in.o  test/dm/built-in.o --end-group arch/arm/lib/eabi_compat.o  -L /usr/local/arm/gcc-linaro-7.5.0-2019.12-x86_64_arm-linux-gnueabihf/bin/../lib/gcc/arm-linux-gnueabihf/7.5.0 -lgcc -Map u-boot.map</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>.u-boot.cmd 使用到了 arm-linux-gnueabihf-ld.bfd，也就是链接工具，使用 ld.bfd 将各个 built-in.o 文件链接在一起就形成了 u-boot 文件。uboot 在编译的时候会将同一个目录中的所有.c 文件都编译在一起，并命名为 built-in.o，相当于将众多的.c 文件对应的.o 文件集合在一起，这个就是 u-boot 文件的来源。</p><p>然后需要转成Imx</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">cmd_u-boot.imx </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> ./tools/mkimage -n</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">board/freescale/mx6ull_alientek_emmc/imximage.cfg.cfgtmp -T imximage - </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">e 0x87800000 -d u-boot.bin u-boot.imx</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>用/tools/mkimage将保存在board/freescale/mx6ullevk/imximage-ddr512.cfg.cfgtmp的 IVT 、 DCD 等数据加到bin的头部合成</p></li><li><p><code>Makefile</code>文件</p><p>顶层调用子模块链接</p></li><li><p><code>u-boot.xxx</code>文件</p><p><code>u-boot</code>：编译出来的  ELF 格式的  uboot 镜像文件。</p><p><code>u-boot.bin</code>：编译出来的二进制格式的  uboot 可执行镜像文件。</p><p><code>u-boot.cfg</code>：uboot 的另外一种配置文件。</p><p><code>u-boot.imx</code>：u-boot.bin 添加头部信息以后的文件，NXP 的 CPU 专用文件。</p><p><code>u-boot.lds</code>：链接脚本。</p><p><code>u-boot.map</code>：uboot 映射文件，通过查看此文件可以知道某个函数被链接到了哪个地址上。</p><p><code>u-boot.srec</code>：S-Record 格式的镜像文件。</p><p><code>u-boot.sym</code>：uboot 符号文件。</p><p><code>u-boot-nodtb.bin</code>：和 u-boot.bin 一样，u-boot.bin 就是  u-boot-nodtb.bin 的复制文件。</p></li><li><p><code>config</code>文件</p><p>uboot 配置文件，使用命令“make xxx_defconfig”配置  uboot 以后就会自动生成</p><p><img loading="lazy" src="https://pic.imgdb.cn/item/64cf08411ddac507cc76588e" alt="image-20230806104057336" class="img_ev3q"></p></li></ol><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="u-boot顶层makefile分析">U-Boot顶层Makefile分析<a href="#u-boot顶层makefile分析" class="hash-link" aria-label="U-Boot顶层Makefile分析的直接链接" title="U-Boot顶层Makefile分析的直接链接">​</a></h4><p>First of all , is the version number . </p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">VERSION </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> 2016</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">PATCHLEVEL </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> 03</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">SUBLEVEL </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">EXTRAVERSION </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">NAME </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li>主版本号</li><li>补丁版本号</li><li>次版本号</li><li>附加版本信息</li><li>名字有关</li></ol><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="makeflags变量">MAKEFLAGS变量<a href="#makeflags变量" class="hash-link" aria-label="MAKEFLAGS变量的直接链接" title="MAKEFLAGS变量的直接链接">​</a></h5><p>make可以递归make子目录然后链接，比如subdir这个子目录，可以通过下面的命令编译子目录</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">MAKE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> -C subdir</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>$(MAKE)</code>即调用make命令， -C指定子目录</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>提示</div><div class="admonitionContent_S0QG"><p>有时候需要向子make传递变量，需要用<code>export</code>来导出，不需要就unexport</p><p>但是有两个特殊的变量：<code>SHELL</code> <code>MAKEFLAGS</code>，这两个变量除非使用“unexport”声明，否则的话在整个 make 的执行过程中，它们的值始终自动的传递给子 make。在 uboot 的主 Makefile中有如下代码：</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">MAKEFLAGS </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> -rR -</span><span class="token keyword" style="color:rgb(86, 156, 214)">-include</span><span class="token plain">-dir</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">CURDIR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>-rR</code>表示禁止使用内置的隐含规则和变量定义，<code>--include-dir</code>指明搜索路径，<code>$(CURDIR)</code>表示当前目录。</p></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="命令输出">命令输出<a href="#命令输出" class="hash-link" aria-label="命令输出的直接链接" title="命令输出的直接链接">​</a></h4><p>编译过程一般都是短命令，需要加<code>V=1</code>来输出完整的命令输出，方便调试</p><p>控制输出的代码：</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">ifeq</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;$(origin V)&quot;</span><span class="token plain">, </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;command line&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  KBUILD_VERBOSE </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">V</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ifndef</span><span class="token plain"> KBUILD_VERBOSE</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  KBUILD_VERBOSE </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> 0</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ifeq</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">KBUILD_VERBOSE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  quiet </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  Q </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  quiet</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">quiet_</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  Q </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">@</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li><p>用<code>ifeq</code>判断$(origin V)和command line时不时一样</p><p>origin是Makefile的函数，用于告诉变量的来源，相当于判断这个V是不是来源于命令行</p></li><li><p>V=1相当于KBUILD_VERBOSE=1</p></li></ol><p>Makefile 中会用到变量  quiet 和  Q 来控制编译的时候是否在终端输出完整的命令，在顶层Makefile 中有很多如下所示的命令：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token constant" style="color:rgb(100, 102, 149)">Q</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token function" style="color:rgb(220, 220, 170)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token constant" style="color:rgb(100, 102, 149)">MAKE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">build</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">tools</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>按照上面来展开，不输出就是@make ...=tools，输出就是make...=tools</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="静默输出">静默输出<a href="#静默输出" class="hash-link" aria-label="静默输出的直接链接" title="静默输出的直接链接">​</a></h4><p>使用<code>make -s</code>静默输出</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># If the user is running make -s (silent mode), suppress echoing of</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># commands</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ifneq</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">filter</span><span class="token plain"> 4.%,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">MAKE_VERSION</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)"># make-4</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ifneq</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">filter</span><span class="token plain"> %s ,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">firstword</span><span class="token plain"> x</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">MAKEFLAGS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  quiet</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">silent_</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain">                    </span><span class="token comment" style="color:rgb(106, 153, 85)"># make-3.8x</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ifneq</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">filter</span><span class="token plain"> s% -s%,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">MAKEFLAGS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  quiet</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">silent_</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">export</span><span class="token plain"> quiet Q KBUILD_VERBOSE</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>用到了<code>filter &lt;parttern...&gt; , &lt;text&gt; </code>过滤单词，查询版本对不对</p><p>获取了MAKEFLAGS的第一个单词，加入-s的编译选项后，<code>firstword=xrRs</code></p><p>展开就是<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>f</mi><mi>i</mi><mi>l</mi><mi>t</mi><mi>e</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">(filter %s, xrRs)，而</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.10764em">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal">lt</span><span class="mord mathnormal" style="margin-right:0.02778em">er</span></span></span></span></span>(filter %s, xrRs)的返回值肯定不为空，条件成立，quiet=silent_</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="设置编译结果输出目录">设置编译结果输出目录<a href="#设置编译结果输出目录" class="hash-link" aria-label="设置编译结果输出目录的直接链接" title="设置编译结果输出目录的直接链接">​</a></h4><blockquote><p>kbuild supports saving output files in a separate directory.</p><p>To locate output files in a separate directory two syntaxes are supporte</p><p>In both cases the working directory must be the root of the kernel src.</p><ol><li><p>O=</p><p>Use &quot;make O=dir/to/store/output/files/&quot;</p></li><li><p>Set KBUILD_OUTPUT
Set the environment variable KBUILD_OUTPUT to point to the directory
where the output files shall be placed.
export KBUILD_OUTPUT=dir/to/store/output/files/
make
The O= assignment takes precedence over the KBUILD_OUTPUT environment
variable.</p></li></ol></blockquote><p>使用<code>O=out</code>来指定输出目录到out</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="代码检查">代码检查<a href="#代码检查" class="hash-link" aria-label="代码检查的直接链接" title="代码检查的直接链接">​</a></h4><p>uboot 支持代码检查，使用命令“make C=1”使能代码检查，检查那些需要<strong>重新编译</strong>的文件。“make C=2”用于检查所有的源码文件，顶层  Makefile 中的代码如下：</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Call a source code checker (by default, &quot;sparse&quot;) as part of the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># C compilation.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Use &#x27;make C=1&#x27; to enable checking of only re-compiled files.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Use &#x27;make C=2&#x27; to enable checking of *all* source files, regardless</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># of whether they are re-compiled or not.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">#</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># See the file &quot;Documentation/sparse.txt&quot; for more details, including</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># where to get the &quot;sparse&quot; utility.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ifeq</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;$(origin C)&quot;</span><span class="token plain">, </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;command line&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  KBUILD_CHECKSRC </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">C</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ifndef</span><span class="token plain"> KBUILD_CHECKSRC</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  KBUILD_CHECKSRC </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> 0</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="模块编译">模块编译<a href="#模块编译" class="hash-link" aria-label="模块编译的直接链接" title="模块编译的直接链接">​</a></h4><p><code>make M=dir</code></p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Use make M=dir to specify directory of external module to build</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Old syntax make ... SUBDIRS=$PWD is still supported</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Setting the environment variable KBUILD_EXTMOD take precedence</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ifdef</span><span class="token plain"> SUBDIRS</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  KBUILD_EXTMOD </span><span class="token operator" style="color:rgb(212, 212, 212)">?=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">SUBDIRS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ifeq</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token string" style="color:rgb(206, 145, 120)">&quot;$(origin M)&quot;</span><span class="token plain">, </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;command line&quot;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  KBUILD_EXTMOD </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">M</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># If building an external module we do not care about the all: rule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># but instead _all depend on modules</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">PHONY </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> all</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ifeq</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">KBUILD_EXTMOD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token target symbol">_all</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> all</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token target symbol">_all</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> modules</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ifeq</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">KBUILD_SRC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)"># building in the source tree</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        srctree </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> .</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">ifeq</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">KBUILD_SRC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">/,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">dir</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">CURDIR</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token comment" style="color:rgb(106, 153, 85)"># building in a subdirectory of the source tree</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                srctree </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> ..</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                srctree </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">KBUILD_SRC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">objtree     </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> .</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">src     </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">srctree</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">obj     </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">objtree</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">VPATH       </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">srctree</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">if</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">KBUILD_EXTMOD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">KBUILD_EXTMOD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">export</span><span class="token plain"> srctree objtree VPATH</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ifeq ($(KBUILD_EXTMOD),)处判断KBUILD_EXTMOD是不是空，为空，让_all=all</p><p>因此要先编译出all。否则的话默认目标_all 依赖  modules，要先编译出  modules，也就是编译模块。一般情况下我们不会在  uboot 中编译模块，所以此处会编译 all 这个目标。</p><p>最后导出变量</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="获取主机架构和系统">获取主机架构和系统<a href="#获取主机架构和系统" class="hash-link" aria-label="获取主机架构和系统的直接链接" title="获取主机架构和系统的直接链接">​</a></h4><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">HOSTARCH </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">shell</span><span class="token plain"> uname -m </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    sed -e s/i.86/x86/ \</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        -e s/sun4u/sparc64/ \</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        -e s/arm.*/arm/ \</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        -e s/sa110/arm/ \</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        -e s/ppc64/powerpc/ \</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        -e s/ppc/powerpc/ \</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        -e s/macppc/powerpc/\</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        -e s/sh.*/sh/</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">HOSTOS </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">shell</span><span class="token plain"> uname -s </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> tr </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;[:upper:]&#x27;</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;[:lower:]&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        sed -e </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;s/\(cygwin\).*/cygwin/&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">export</span><span class="token plain">  HOSTARCH HOSTOS</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>调用SHELL获取当前系统架构与主机OS（会将大写的Linux换成小写的）</p><p>看了一下，好像可以用cygwin在win端做Uboot的交叉编译</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="设置目标架构交叉编译器配置文件">设置目标架构、交叉编译器、配置文件<a href="#设置目标架构交叉编译器配置文件" class="hash-link" aria-label="设置目标架构、交叉编译器、配置文件的直接链接" title="设置目标架构、交叉编译器、配置文件的直接链接">​</a></h4><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># set default to nothing for native builds</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ifeq</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">HOSTARCH</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ARCH</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">CROSS_COMPILE </span><span class="token operator" style="color:rgb(212, 212, 212)">?=</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">KCONFIG_CONFIG  </span><span class="token operator" style="color:rgb(212, 212, 212)">?=</span><span class="token plain"> .config</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">export</span><span class="token plain"> KCONFIG_CONFIG</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>判断是不是架构一致</p><p>可以直接修改顶层 Makefile，在里面加入 <code>ARCH </code>和 <code>CROSS_COMPILE</code> 的定义</p><p>可以看到调用了.config，是kconfig生成的，基本上是从defconfig搬过来</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="调用scriptskbuildinclude">调用scripts/Kbuild.include<a href="#调用scriptskbuildinclude" class="hash-link" aria-label="调用scripts/Kbuild.include的直接链接" title="调用scripts/Kbuild.include的直接链接">​</a></h4><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># We need some generic definitions (do not try to remake the file).</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token target symbol">scripts/Kbuild.include</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">include</span><span class="token plain"> scripts/Kbuild.</span><span class="token keyword" style="color:rgb(86, 156, 214)">include</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>用include包含了里面的很多变量</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="交叉编译工具变量设置">交叉编译工具变量设置<a href="#交叉编译工具变量设置" class="hash-link" aria-label="交叉编译工具变量设置的直接链接" title="交叉编译工具变量设置的直接链接">​</a></h4><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Make variables (CC, etc...)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">AS      </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">CROSS_COMPILE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">as</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Always use GNU ld</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ifneq</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">shell</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">CROSS_COMPILE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">ld.bfd -v 2&gt; /dev/null</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">LD      </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">CROSS_COMPILE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">ld.bfd</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">LD      </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">CROSS_COMPILE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">ld</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">CC      </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">CROSS_COMPILE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">gcc</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">CPP     </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">CC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> -E</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">AR      </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">CROSS_COMPILE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">ar</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">NM      </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">CROSS_COMPILE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">nm</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">LDR     </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">CROSS_COMPILE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">ldr</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">STRIP       </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">CROSS_COMPILE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">strip</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">OBJCOPY     </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">CROSS_COMPILE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">objcopy</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">OBJDUMP     </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">CROSS_COMPILE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">objdump</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>所见即所得</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="导出其他变量">导出其他变量<a href="#导出其他变量" class="hash-link" aria-label="导出其他变量的直接链接" title="导出其他变量的直接链接">​</a></h4><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">export</span><span class="token plain"> VERSION PATCHLEVEL SUBLEVEL UBOOTRELEASE UBOOTVERSION</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">export</span><span class="token plain"> ARCH CPU BOARD VENDOR SOC CPUDIR BOARDDIR</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">export</span><span class="token plain"> CONFIG_SHELL HOSTCC HOSTCFLAGS HOSTLDFLAGS CROSS_COMPILE AS LD CC</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">export</span><span class="token plain"> CPP AR NM LDR STRIP OBJCOPY OBJDUMP</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">export</span><span class="token plain"> MAKE AWK PERL PYTHON</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">export</span><span class="token plain"> HOSTCXX HOSTCXXFLAGS DTC CHECK CHECKFLAGS</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">export</span><span class="token plain"> KBUILD_CPPFLAGS NOSTDINC_FLAGS UBOOTINCLUDE OBJCOPYFLAGS LDFLAGS</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">export</span><span class="token plain"> KBUILD_CFLAGS KBUILD_AFLAGS</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>重点看看<code>ARCH CPU BOARD VENDOR SOC CPUDIR BOARDDIR</code></p><p><img loading="lazy" src="https://pic.imgdb.cn/item/64d09a811ddac507ccd220a2" alt="image-20230807151712823" class="img_ev3q"></p><p>这几个变量哪来的？</p><p>在<code>config.mk</code>，这  7 个变量就是在  config.mk 里面定义的</p><p>里面的变量又由.config定义</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="make-xxx_defconfig过程">make xxx_defconfig过程<a href="#make-xxx_defconfig过程" class="hash-link" aria-label="make xxx_defconfig过程的直接链接" title="make xxx_defconfig过程的直接链接">​</a></h4><p>其实学到这里已经想起飞了，感觉讲的有点乱</p><p>对整体的Makefile架构极其混乱</p><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="scripts_basic-目标对应的命令">scripts_basic 目标对应的命令<a href="#scripts_basic-目标对应的命令" class="hash-link" aria-label="scripts_basic 目标对应的命令的直接链接" title="scripts_basic 目标对应的命令的直接链接">​</a></h5><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Basic helpers built in scripts/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">PHONY </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> scripts_basic</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token target symbol">scripts_basic</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Q</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">MAKE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">build</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">scripts/basic</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Q</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">rm -f .tmp_quiet_recordmcount</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># To avoid any implicit rule to kick in, define an empty command.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token target symbol">scripts/basic/%</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> scripts_basic </span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">PHONY </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> outputmakefile</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># outputmakefile generates a Makefile in the output directory, if using a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># separate output directory. This allows convenient use of make in the</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># output directory.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># 一般来说KBUILD_SRC为空，所以只有scripts_basic有用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token target symbol">outputmakefile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ifneq</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">KBUILD_SRC</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Q</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">ln -fsn </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">srctree</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> source</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Q</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">CONFIG_SHELL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">srctree</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">/scripts/mkmakefile \</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">srctree</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">objtree</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">VERSION</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">PATCHLEVEL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这部分感觉正点讲的不是很清晰</p><p>看上面<code>KBUILD_SRC</code>的说明，这玩意不适合regular user (for now)</p><p>所以专注于</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Q</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">MAKE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">build</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">scripts/basic</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这句编译下来就是<code>make -f $(srctree)/scripts/Makefile.build obj==scripts/basic</code></p><p><code>srctree</code>为<code>.</code>-&gt;./scripts/Makefile.build</p><p>now ,我们需要看看<code>./scripts/Makefile.build</code></p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># The filename Kbuild has precedence over Makefile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">kbuild-dir </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">if</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">filter</span><span class="token plain"> /%,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">src</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">src</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">srctree</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">/</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">src</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">kbuild-file </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">if</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">wildcard</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">kbuild-dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">/Kbuild</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">kbuild-dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">/Kbuild,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">kbuild-dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">/Makefile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">include</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">kbuild-file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>kbuild-dir</code>展开后=$(if $(filter /%, scripts/basic),  <strong>scripts/basic</strong> ,  <strong>./scripts/basic</strong>)</p><p><code>kbuild-file </code>展开后=<span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>i</mi><mi>f</mi></mrow><annotation encoding="application/x-tex">(if</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em"></span><span class="mopen">(</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.10764em">f</span></span></span></span></span>(wildcard./scripts/basic/Kbuild),<strong>./scripts/basic/Kbuild</strong>, <strong>./scripts/basic/Makefile</strong>)</p><p>也=./scripts/basic/Makefile，因为没有Kbuild</p><p><code>include $(kbuild-file)</code>=./scripts/basic/Makefile</p><p>继续看Makefile.build</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># We keep a list of all modules in $(MODVERDIR)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token target symbol">__build</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">if</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">KBUILD_BUILTIN</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">builtin-target</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">lib-target</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">extra-y</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">if</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">KBUILD_MODULES</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">obj-m</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">modorder-target</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> \</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">subdir-ym</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">always</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token target symbol">    @</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>__build这哥们是默认的，一般make后没有指定目标会执行这个</p><p>在顶层的Makefile里，KBUILD_BUILTIN=1，KBUILD_MODULES=0，</p><p>因此展开<strong>build 后= </strong></p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token literal-property property">build</span><span class="token operator" style="color:rgb(212, 212, 212)">:</span><span class="token function" style="color:rgb(220, 220, 170)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">builtin</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">target</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">lib</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">target</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">extra</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">y</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">subdir</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">ym</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">always</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>KBUILD_MODULES搞没了</p><p>所以__build 有 5 个依赖：<code>builtin-target</code>、<code>lib-target</code>、<code>extra-y</code>、<code>subdir-ym</code> 和 <code>always</code></p><p>最后echo发现只有always有路径，依赖于  scripts/basic/fixdep（some dependences）</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>提示</div><div class="admonitionContent_S0QG"><p><strong>综上所述，scripts_basic 目标的作用就是编译出  scripts/basic/fixdep.c这个软件。</strong></p></div></div><h5 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="config-目标对应的命令">%config 目标对应的命令<a href="#config-目标对应的命令" class="hash-link" aria-label="%config 目标对应的命令的直接链接" title="%config 目标对应的命令的直接链接">​</a></h5><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token target symbol">config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> scripts_basic outputmakefile FORCE</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Q</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">MAKE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">build</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">scripts/kconfig </span><span class="token variable" style="color:rgb(156, 220, 254)">$@</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token target symbol">%config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> scripts_basic outputmakefile FORCE</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Q</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">MAKE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">build</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">scripts/kconfig </span><span class="token variable" style="color:rgb(156, 220, 254)">$@</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>老顾客make + build 了</p><p>翻译成人话就是</p><p><code>@make  -f  ./scripts/Makefile.build  obj=scripts/kconfig 
xxx_defconfig</code></p><p><img loading="lazy" src="https://pic.imgdb.cn/item/64d774c31ddac507cc12bd43" alt="image-20230812200201720" class="img_ev3q"></p><p> 在解释一下各部分变量</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># Modified for U-Boot</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># pattern 用于替换(删除 src中的tpl/部分</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># but we dont hava any pattern like tpl or spl</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># so src = obj</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">prefix </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> tpl</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">src </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">patsubst</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">prefix</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">/%,%,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ifeq</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">src</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">prefix </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> spl</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">src </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">patsubst</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">prefix</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">/%,%,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ifeq</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">src</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">prefix </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> .</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># The filename Kbuild has precedence over Makefile</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">kbuild-dir </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">if</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">filter</span><span class="token plain"> /%,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">src</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">src</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">srctree</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">/</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">src</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">kbuild-file </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">if</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">wildcard</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">kbuild-dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">/Kbuild</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">kbuild-dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">/Kbuild,</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">kbuild-dir</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">/Makefile</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">include</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">kbuild-file</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><blockquote><p>src= scripts/kconfig</p><p>kbuild-dir = ./scripts/kconfig </p><p>kbuild-file = ./scripts/kconfig/Makefile </p><p>include ./scripts/kconfig/Makefile</p></blockquote><p>读取了 ./scripts/kconfig/Makefile ，</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token target symbol">%_defconfig</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">obj</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">/conf</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Q</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token variable" style="color:rgb(156, 220, 254)">$&lt;</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">silent</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> --defconfig</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">arch/</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">SRCARCH</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">/configs/</span><span class="token variable" style="color:rgb(156, 220, 254)">$@</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">Kconfig</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># Added for U-Boot (backward compatibility)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token target symbol">%_config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> %_defconfig</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token target symbol">    @</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>然后这个，符合了我们之前的什么xxx_defconfig的规则</p><p>展开后就是 scripts/kconfig/conf</p><p>接下来就是检查并生成依赖 scripts/kconfig/conf。 </p><p>conf 是主机软件，到这里我们就打住，不要纠结 conf 是怎么编译出来的，否则就越陷越深，太绕了，像 conf 这种主机所使用的工具类软件我们一般不关心它是如何编译产生的。如果一定要看是 conf 是怎么生成的，可以输入如下命令重新配置 uboot，在重新配置 uboot 的过程中就会输出 conf 编译信息。</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">make</span><span class="token plain"> distclean</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token function" style="color:rgb(220, 220, 170)">make</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(156, 220, 254)">ARCH</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">arm </span><span class="token assign-left variable" style="color:rgb(156, 220, 254)">CROSS_COMPILE</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain">arm-linux-gnueabihf- mx6ull_14x14_ddr512_emmc_ </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">defconfig  </span><span class="token assign-left variable" style="color:rgb(156, 220, 254)">V</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>$(SRCARCH)</code>=..</p><p>将其展开就是：<code>@ scripts/kconfig/conf --defconfig=arch/../configs/xxx_defconfig Kconfig</code></p><p><img loading="lazy" src="https://pic.imgdb.cn/item/64de1c11661c6c8e545a22ca" alt="image-20230817210928995" class="img_ev3q"></p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="u-bootbin怎么生成">u-boot.bin怎么生成<a href="#u-bootbin怎么生成" class="hash-link" aria-label="u-boot.bin怎么生成的直接链接" title="u-boot.bin怎么生成的直接链接">​</a></h3><p>总的：</p><div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">make </span><span class="token constant" style="color:rgb(100, 102, 149)">V</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token plain">j16</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="theme-admonition theme-admonition-warning alert alert--danger admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M5.05.31c.81 2.17.41 3.38-.52 4.31C3.55 5.67 1.98 6.45.9 7.98c-1.45 2.05-1.7 6.53 3.53 7.7-2.2-1.16-2.67-4.52-.3-6.61-.61 2.03.53 3.33 1.94 2.86 1.39-.47 2.3.53 2.27 1.67-.02.78-.31 1.44-1.13 1.81 3.42-.59 4.78-3.42 4.78-5.56 0-2.84-2.53-3.22-1.25-5.61-1.52.13-2.03 1.13-1.89 2.75.09 1.08-1.02 1.8-1.86 1.33-.67-.41-.66-1.19-.06-1.78C8.18 5.31 8.68 2.45 5.05.32L5.03.3l.02.01z"></path></svg></span>注意</div><div class="admonitionContent_S0QG"><p>据说学习太多这些makefile用不上，学太细也会忘，过一下就好</p></div></div><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="默认目标">默认目标<a href="#默认目标" class="hash-link" aria-label="默认目标的直接链接" title="默认目标的直接链接">​</a></h4><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># That&#x27;s our default target when none is given on the command line</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">PHONY </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> _all</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token target symbol">_all</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>后面的代码还有，可能将_all覆盖</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"># If building an external module we do not care about the all: rule</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)"># but instead _all depend on modules</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">PHONY </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> all</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ifeq</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">KBUILD_EXTMOD</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token target symbol">_all</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> all</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token target symbol">_all</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> modules</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>继续找<code>all</code></p><p>在800多行我们找到了</p><p><code>all:     $(ALL-y)</code></p><p>这玩意=<code>ALL-y+=u-boot.srec u-boot.bin u-boot.sym System.map u-boot.cfg binary_size_check</code></p><p>看到了u-boot.bin了，再搜</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token target symbol">u-boot.bin</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> u-boot-dtb.bin FORCE</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">call</span><span class="token plain"> if_changed,copy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token target symbol">u-boot.bin</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> u-boot-nodtb.bin FORCE</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">call</span><span class="token plain"> if_changed,copy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>可以看到又回来u-boot-nodtb.bin了</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token target symbol">u-boot-nodtb.bin</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> u-boot FORCE</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">call</span><span class="token plain"> if_changed,objcopy</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">call</span><span class="token plain"> DO_STATIC_RELA,</span><span class="token variable" style="color:rgb(156, 220, 254)">$&lt;,$@,$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">CONFIG_SYS_TEXT_BASE</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">BOARD_SIZE_CHECK</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>又回到了u-boot，翻到1100+行终于找到</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token target symbol">u-boot</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">u-boot-init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">u-boot-main</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> u-boot.lds FORCE</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">call</span><span class="token plain"> if_changed,u-boot__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">ifeq</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">CONFIG_KALLSYMS</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">,y</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">call</span><span class="token plain"> cmd,smap</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">call</span><span class="token plain"> cmd,u-boot__</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"> common/system_map.o</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>这里将$(u-boot-init) $(u-boot-main)用lds链接在了一起</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">u-boot-init </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">head-y</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">u-boot-main </span><span class="token operator" style="color:rgb(212, 212, 212)">:=</span><span class="token plain"> </span><span class="token variable" style="color:rgb(156, 220, 254)">$</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">libs-y</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>$(head-y)与cpu架构有关，不在这个Makefile里，head-y= arch/arm/cpu/armv7/start.o</p><p>$(libs-y)是Uboot文件里的源码集合，具体是</p><blockquote><p>libs-y=保存源码的目录</p><p>such as</p><div class="language-makefile codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-makefile codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">libs-y </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> fs/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">libs-y </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> net/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">libs-y </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> disk/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">libs-y </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> drivers/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">libs-y </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> drivers/dma/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">libs-y </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> drivers/gpio/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">libs-y </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> drivers/i2c/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">libs-y </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> drivers/mmc/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">libs-y </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> drivers/mtd/</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>libs-y += lib/ -》lib/built-in.o</p><p>libs-y保存大量的built-in.o</p></blockquote><blockquote><p>u-boot就是将start.o 和大量的built-in.o链接在一起。</p></blockquote><p>假如</p><p>CONFIG_ONENAND_U_BOOT =y</p><p>ALL-$(CONFIG_ONENAND_U_BOOT) </p><p>ALL-y += u-boot-onenand.bin</p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="链接">链接<a href="#链接" class="hash-link" aria-label="链接的直接链接" title="链接的直接链接">​</a></h4><p>链接脚本为u-boot.lds，uboot链接首地址为0X87800000</p><p><img loading="lazy" src="https://pic.imgdb.cn/item/64de391c661c6c8e54db6887" alt="image-20230817231330386" class="img_ev3q"></p><p>search得知，在<code>mx6_common.h</code>文件中设置<code>CONFIG_SYS_TEXT_BASE=0X87800000</code></p><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="summary">summary<a href="#summary" class="hash-link" aria-label="summary的直接链接" title="summary的直接链接">​</a></h4><p><img loading="lazy" src="https://pic.imgdb.cn/item/64de3956661c6c8e54dc560c" alt="image-20230817231429090" class="img_ev3q"></p><p>支持正点原子就到此打住，他们说Uboot和linux大差不差，后期在学吧</p><p>（为什么不用cmake，why？</p><h3 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="uboot启动流程">Uboot启动流程<a href="#uboot启动流程" class="hash-link" aria-label="Uboot启动流程的直接链接" title="Uboot启动流程的直接链接">​</a></h3><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="u-bootlds">u-boot.lds<a href="#u-bootlds" class="hash-link" aria-label="u-boot.lds的直接链接" title="u-boot.lds的直接链接">​</a></h4><ol><li><p>入口地址为_start
在arch/arm/lib/vectors.S中定义</p><div class="language-assembly codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-assembly codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">_start:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#ifdef CONFIG_SYS_DV_NOR_BOOT_CFG</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    .word   CONFIG_SYS_DV_NOR_BOOT_CFG</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    b   reset</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ldr pc, _undefined_instruction</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ldr pc, _software_interrupt</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ldr pc, _prefetch_abort</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ldr pc, _data_abort</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ldr pc, _not_used</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ldr pc, _irq</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ldr pc, _fiq</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><p><code>.__image_copy_start</code> 0x87800000</p></li><li><p><code>.vectors</code> 0x87800000放中断向量表</p></li><li><p><code>arch/arm/cpu/armv7/start.o start.c</code></p></li><li><p><code>.image_copy_end</code>，这两货的中间是拷贝镜像？</p></li></ol><ol><li><code>rel_dyn_start</code>rel段，很小，35k</li><li><code>__rel_dyn_end</code>衔接__end</li></ol><ol><li><code>bss_start</code></li></ol><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="函数">函数<a href="#函数" class="hash-link" aria-label="函数的直接链接" title="函数的直接链接">​</a></h4><ol><li><p><code>reset</code></p><div class="language-assembly codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-assembly codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">reset:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /* Allow the board to save important registers */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    b   save_boot_params</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">save_boot_params_ret:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /*</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     * disable interrupts (FIQ and IRQ), also set the cpu to SVC32 mode,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     * except if in HYP mode already</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    mrs r0, cpsr</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    and r1, r0, #0x1f       @ mask mode bits</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    teq r1, #0x1a       @ test for HYP mode</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    bicne   r0, r0, #0x1f       @ clear all mode bits</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    orrne   r0, r0, #0x13       @ set SVC mode</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    orr r0, r0, #0xc0       @ disable FIQ and IRQ</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    msr cpsr,r0</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>将处理器设置为svc mode，关闭FIQ、IRQ</p><p>然后设置vector</p><div class="language-assembly codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-assembly codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> * Setup vector:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> * (OMAP4 spl TEXT_BASE is not 32 byte aligned.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> * Continue to use ROM code vector only in OMAP4 spl)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#if !(defined(CONFIG_OMAP44XX) &amp;&amp; defined(CONFIG_SPL_BUILD))</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /* Set V=0 in CP15 SCTLR register - for VBAR to point to vector */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    mrc p15, 0, r0, c1, c0, 0   @ Read CP15 SCTLR Register</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    bic r0, #CR_V       @ V = 0控制bit13的V位，向量表控制位，重定位向量表</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    mcr p15, 0, r0, c1, c0, 0   @ Write CP15 SCTLR Register</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /* Set vector address in CP15 VBAR register */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ldr r0, =_start</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    mcr p15, 0, r0, c12, c0, 0  @Set VBAR</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li></ol><div class="language-assembly codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-assembly codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /* the mask ROM code should have PLL and others stable */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#ifndef CONFIG_SKIP_LOWLEVEL_INIT</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    bl  cpu_init_cp15</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    bl  cpu_init_crit</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>   可以看到这是底层的init，下面就是具体的</p><div class="language-assembly codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-assembly codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">#ifndef CONFIG_SKIP_LOWLEVEL_INIT</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/*************************************************************************</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> * CPU_init_critical registers</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> * setup important registers</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> * setup memory timing</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">*************************************************************************/</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">ENTRY(cpu_init_crit)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /*</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     * Jump to board specific initialization...</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     * The Mask ROM will have already initialized</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     * basic memory. Go here to bump up clock rate and handle</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     * wake up conditions.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    b   lowlevel_init       @ go setup pll,mux,memory</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">ENDPROC(cpu_init_crit)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>   函数lowlevel_init在文件arch/arm/cpu/armv7/lowlevel_init.S 中定义</p><div class="language-assembly codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-assembly codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">ENTRY(lowlevel_init)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /*</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     * Setup a temporary stack. Global data is not available yet.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    # 初始化SP</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    #设置  sp 指向   CONFIG_SYS_INIT_SP_ADDR，CONFIG_SYS_INIT_SP_ADDR 在 include/configs/mx6ullevk.h 文件中，在  mx6ullevk.h 中有如下所示定义</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ldr sp, =CONFIG_SYS_INIT_SP_ADDR</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    bic sp, sp, #7 /* 8-byte alignment for ABI compliance */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#ifdef CONFIG_SPL_DM</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    mov r9, #0</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#else</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /*</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     * Set up global data for boards that still need it. This will be</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     * removed soon.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#ifdef CONFIG_SPL_BUILD</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ldr r9, =gdata</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#else</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    sub sp, sp, #GD_SIZE</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    bic sp, sp, #7</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    mov r9, sp</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /*</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     * Save the old lr(passed in ip) and the current lr to stack</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    push    {ip, lr}</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    /*</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     * Call the very early init function. This should do only the</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     * absolute bare minimum to get started. It should not:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     * - set up DRAM</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     * - use global_data</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     * - clear BSS</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     * - try to start a console</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     *</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     * For boards with SPL this should be empty since SPL can do all of</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     * this init in the SPL board_init_f() function which is called</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     * immediately after this.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    bl  s_init</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    pop {ip, pc}</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">ENDPROC(lowlevel_init)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li><p>sp 指向   CONFIG_SYS_INIT_SP_ADDR，在include/configs/mx6ullevk.h 文件中</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">CONFIG_SYS_SDRAM_BASE</span><span class="token macro property">       </span><span class="token macro property expression">PHYS_SDRAM</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">CONFIG_SYS_INIT_RAM_ADDR</span><span class="token macro property">    </span><span class="token macro property expression">IRAM_BASE_ADDR</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">CONFIG_SYS_INIT_RAM_SIZE</span><span class="token macro property">    </span><span class="token macro property expression">IRAM_SIZE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">CONFIG_SYS_INIT_SP_OFFSET</span><span class="token macro property"> </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">    </span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">CONFIG_SYS_INIT_RAM_SIZE </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">-</span><span class="token macro property expression"> GENERATED_GBL_DATA_SIZE</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">CONFIG_SYS_INIT_SP_ADDR</span><span class="token macro property"> </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">    </span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">CONFIG_SYS_INIT_RAM_ADDR </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">+</span><span class="token macro property expression"> CONFIG_SYS_INIT_SP_OFFSET</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>指向的<code>IRAM_BASE_ADDR</code>在<code>arch/arm/include/asm/arch-mx6/imx-regs.h</code>定义</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">IRAM_BASE_ADDR</span><span class="token macro property">           </span><span class="token macro property expression number" style="color:rgb(181, 206, 168)">0x00900000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">if</span><span class="token macro property"> </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">!</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">defined</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">CONFIG_MX6SX</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression"> </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">||</span><span class="token macro property expression"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">defined</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">CONFIG_MX6UL</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression"> </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">||</span><span class="token macro property expression"> </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">    </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">defined</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">CONFIG_MX6SLL</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression"> </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">||</span><span class="token macro property expression"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">defined</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">CONFIG_MX6SL</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">IRAM_SIZE</span><span class="token macro property">                    </span><span class="token macro property expression number" style="color:rgb(181, 206, 168)">0x00040000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">IRAM_SIZE</span><span class="token macro property">                    </span><span class="token macro property expression number" style="color:rgb(181, 206, 168)">0x00020000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>最终是IRAM_SIZE=0x00020000=128KB</p><p>还要知道<code>GENERATED_GBL_DATA_SIZE</code>的值，在文件 include/generated/generic-asm-offsets.h</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">ifndef</span><span class="token macro property"> </span><span class="token macro property expression">__GENERIC_ASM_OFFSETS_H__</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">__GENERIC_ASM_OFFSETS_H__</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">GENERATED_GBL_DATA_SIZE</span><span class="token macro property"> </span><span class="token macro property expression number" style="color:rgb(181, 206, 168)">256</span><span class="token macro property expression"> </span><span class="token macro property comment" style="color:rgb(106, 153, 85)">/* (sizeof(struct global_data) + 15) &amp; ~15  @ */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">GENERATED_BD_INFO_SIZE</span><span class="token macro property"> </span><span class="token macro property expression number" style="color:rgb(181, 206, 168)">80</span><span class="token macro property expression"> </span><span class="token macro property comment" style="color:rgb(106, 153, 85)">/* (sizeof(struct bd_info) + 15) &amp; ~15    @ */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">GD_SIZE</span><span class="token macro property"> </span><span class="token macro property expression number" style="color:rgb(181, 206, 168)">248</span><span class="token macro property expression"> </span><span class="token macro property comment" style="color:rgb(106, 153, 85)">/* sizeof(struct global_data)   @ */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">GD_BD</span><span class="token macro property"> </span><span class="token macro property expression number" style="color:rgb(181, 206, 168)">0</span><span class="token macro property expression"> </span><span class="token macro property comment" style="color:rgb(106, 153, 85)">/* offsetof(struct global_data, bd) @ */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">GD_MALLOC_BASE</span><span class="token macro property"> </span><span class="token macro property expression number" style="color:rgb(181, 206, 168)">188</span><span class="token macro property expression"> </span><span class="token macro property comment" style="color:rgb(106, 153, 85)">/* offsetof(struct global_data, malloc_base) @ */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">GD_RELOCADDR</span><span class="token macro property"> </span><span class="token macro property expression number" style="color:rgb(181, 206, 168)">44</span><span class="token macro property expression"> </span><span class="token macro property comment" style="color:rgb(106, 153, 85)">/* offsetof(struct global_data, relocaddr)  @ */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">GD_RELOC_OFF</span><span class="token macro property"> </span><span class="token macro property expression number" style="color:rgb(181, 206, 168)">64</span><span class="token macro property expression"> </span><span class="token macro property comment" style="color:rgb(106, 153, 85)">/* offsetof(struct global_data, reloc_off)  @ */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name">GD_START_ADDR_SP</span><span class="token macro property"> </span><span class="token macro property expression number" style="color:rgb(181, 206, 168)">60</span><span class="token macro property expression"> </span><span class="token macro property comment" style="color:rgb(106, 153, 85)">/* offsetof(struct global_data, start_addr_sp)  @ */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>gd=256</p><p><code>CONFIG_SYS_INIT_SP_OFFSET</code>=<code>CONFIG_SYS_INIT_RAM_SIZE</code> - <code>GENERATED_GBL_DATA_SIZE</code></p><p>=0x00020000-256=0x1FF00</p><p><code>CONFIG_SYS_INIT_SP_ADDR</code>=<code>CONFIG_SYS_INIT_RAM_ADDR</code> + <code>CONFIG_SYS_INIT_SP_OFFSET</code></p><p>=0x00900000+0x1FF00= 0X0091FF00</p><p>总结：设置SP指针，R9寄存器，运行s_init</p></li><li><p><code>s_init函数</code></p><p>啥也没干，return了</p></li><li><p><code>_main函数</code></p><ol><li><p>设置栈指针as <code>CONFIG_SYS_INIT_SP_ADDR</code></p></li><li><p>对其做8byte alignment</p></li><li><p>将sp作为入参，bl to <code>board_init_f_alloc_reserve</code>，顾名思义应该是留出早期的 malloc 内存区域和 gd 内存区域
<code>CONFIG_SYS_MALLOC_F_LEN</code>=0X400( 在 文 件 include/generated/autoconf.h 中定义) </p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">define</span><span class="token macro property"> </span><span class="token macro property macro-name function" style="color:rgb(220, 220, 170)">rounddown</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">x</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token macro property expression"> y</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression"> </span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">               </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property"></span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token macro property expression">                           </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">    </span><span class="token macro property expression keyword" style="color:rgb(86, 156, 214)">typeof</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">x</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression"> __x </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">=</span><span class="token macro property expression"> </span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">x</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token macro property expression">                </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">    </span><span class="token macro property expression">__x </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">-</span><span class="token macro property expression"> </span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">__x </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">%</span><span class="token macro property expression"> </span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">y</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token macro property expression">              </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property"></span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token macro property expression">                           </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property"></span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">ulong </span><span class="token function" style="color:rgb(220, 220, 170)">board_init_f_alloc_reserve</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ulong top</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">/* Reserve early malloc arena */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">if</span><span class="token macro property"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">defined</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">CONFIG_SYS_MALLOC_F</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    top </span><span class="token operator" style="color:rgb(212, 212, 212)">-=</span><span class="token plain"> CONFIG_SYS_MALLOC_F_LEN</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">/* LAST : reserve GD (rounded up to a multiple of 16 bytes) */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    top </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">rounddown</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">top</span><span class="token operator" style="color:rgb(212, 212, 212)">-</span><span class="token keyword" style="color:rgb(86, 156, 214)">sizeof</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">global_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">16</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">return</span><span class="token plain"> top</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" src="https://pic.imgdb.cn/item/64df3eea661c6c8e54944fb6" alt="image-20230818175026568" class="img_ev3q"></p><p>将返回的top=r0写入sp</p></li><li><p>将  r0 寄存器的值写到寄存器  r9 里面，因为  r9 寄存器存放着全局变量  gd 的地址（set up gd outside any C code</p></li><li><p>bl to <code>board_init_f_init_reserve</code></p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">/*</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * Initialize reserved space (which has been safely allocated on the C</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * stack from the C runtime environment handling code).</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * Notes:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * Actual reservation was done by the caller; the locations from base</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * to base+size-1 (where &#x27;size&#x27; is the value returned by the allocation</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * function above) can be accessed freely without risk of corrupting the</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * C runtime environment.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * IMPORTANT:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * Upon return from the allocation function above, on some architectures</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * the caller will set gd to the lowest reserved location. Therefore, in</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * this initialization function, the global data MUST be placed at base.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * ALSO IMPORTANT:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * On some architectures, gd will already be good when entering this</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * function. On others, it will only be good once arch_setup_gd() returns.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * Therefore, global data accesses must be done:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * - through gd_ptr if before the call to arch_setup_gd();</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * - through gd once arch_setup_gd() has been called.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * Do not use &#x27;gd-&gt;&#x27; until arch_setup_gd() has been called!</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * IMPORTANT TOO:</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> *</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * Initialization for each &quot;chunk&quot; (GD, early malloc arena...) ends with</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * an incrementation line of the form &#x27;base += &lt;some size&gt;&#x27;. The last of</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * these incrementations seems useless, as base will not be used any</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * more after this incrementation; but if/when a new &quot;chunk&quot; is appended,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * this increment will be essential as it will give base right value for</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * this new chunk (which will have to end with its own incrementation</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * statement). Besides, the compiler&#x27;s optimizer will silently detect</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * and remove the last base incrementation, therefore leaving that last</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> * (seemingly useless) incrementation causes no code increase.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">board_init_f_init_reserve</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ulong base</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">global_data</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">gd_ptr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">ifndef</span><span class="token macro property"> </span><span class="token macro property expression">_USE_MEMCPY</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">ptr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">/*</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     * clear GD entirely and set it up.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     * Use gd_ptr, as gd may not be properly set yet.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    gd_ptr </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">global_data</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">base</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">/* zero the area */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">ifdef</span><span class="token macro property"> </span><span class="token macro property expression">_USE_MEMCPY</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">memset</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">gd_ptr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token char" style="color:rgb(209, 105, 105)">&#x27;\0&#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(86, 156, 214)">sizeof</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">gd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">for</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ptr </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain">gd_ptr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"> ptr </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">int</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">gd_ptr </span><span class="token operator" style="color:rgb(212, 212, 212)">+</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token operator" style="color:rgb(212, 212, 212)">*</span><span class="token plain">ptr</span><span class="token operator" style="color:rgb(212, 212, 212)">++</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">/* set GD unless architecture did it already */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">if</span><span class="token macro property"> </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">!</span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">defined</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">CONFIG_ARM</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">arch_setup_gd</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">gd_ptr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">/* next alloc will be higher by one GD plus 16-byte alignment */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    base </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">roundup</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">sizeof</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token keyword" style="color:rgb(86, 156, 214)">struct</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">global_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">16</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">/*</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     * record early malloc arena start.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     * Use gd as it is now properly set for all architectures.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">if</span><span class="token macro property"> </span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">defined</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">CONFIG_SYS_MALLOC_F</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">/* go down one &#x27;early malloc arena&#x27; */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    gd</span><span class="token operator" style="color:rgb(212, 212, 212)">-&gt;</span><span class="token plain">malloc_base </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> base</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">/* next alloc will be higher by one &#x27;early malloc arena&#x27; size */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    base </span><span class="token operator" style="color:rgb(212, 212, 212)">+=</span><span class="token plain"> CONFIG_SYS_MALLOC_F_LEN</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>也就是很纯粹的menset=0，ARM端做16字节对齐，gd-&gt;malloc_base=0X0091FB00，early malloc base</p></li><li><p><code>mov r0,#0</code>对r0清零</p></li><li><p>bl to <code>board_init_f</code>用于初始化DDR、定时器、代码拷贝等等</p></li><li><p><code>ldr   sp, [r9, #GD_START_ADDR_SP] /* sp = gd-&gt;start_addr_sp */</code></p><p>Set up intermediate environment (new sp and gd) and call relocate_code(addr_moni). Trick here is that we&#x27;ll return &#x27;here&#x27; but relocated.设置刚刚搞好的gd-&gt;？？？为sp</p></li><li><p>将uboot拷贝到DDR最后面的地址去<code>/* r0 = gd-&gt;relocaddr */</code></p></li><li><p>b to <strong><code>relocate_code</code></strong> copy code </p></li><li><p>bl to <code>relocate_vectors</code>重定位中断向量表</p></li><li><p>bl to <code>c_runtime_cpu_setup</code></p><div class="language-assembly codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-assembly codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">ENTRY(c_runtime_cpu_setup)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> * If I-cache is enabled invalidate it</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#ifndef CONFIG_SYS_ICACHE_OFF</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    mcr p15, 0, r0, c7, c5, 0   @ invalidate icache</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    mcr     p15, 0, r0, c7, c10, 4  @ DSB</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    mcr     p15, 0, r0, c7, c5, 4   @ ISB</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    bx  lr</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">ENDPROC(c_runtime_cpu_setup)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></li><li><div class="language-assembly codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-assembly codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ldr r0, =__bss_start    /* this is auto-relocated! */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#ifdef CONFIG_USE_ARCH_MEMSET</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ldr r3, =__bss_end      /* this is auto-relocated! */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    mov r1, #0x00000000     /* prepare zero to clear BSS */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    subs    r2, r3, r0      /* r2 = memset len */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    bl  memset</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#else</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    ldr r1, =__bss_end      /* this is auto-relocated! */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    mov r2, #0x00000000     /* prepare zero to clear BSS */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">clbss_l:cmp r0, r1          /* while not at end of BSS */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#if defined(CONFIG_CPU_V7M)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    itt lo</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#endif</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    strlo   r2, [r0]        /* clear 32-bit BSS word */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    addlo   r0, r0, #4      /* move to next */</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    blo clbss_l</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">#endif</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>清除BSS段</p></li><li><p>调用<code>board_init_r</code></p></li></ol><p>now focus on <code>board_init_f</code>、<code>relocate_code</code>、 <code>relocate_vectors</code> 和<code> board_init_r</code> 这 4 个函数</p></li></ol><h4 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="board_init_f-函数">board_init_f 函数<a href="#board_init_f-函数" class="hash-link" aria-label="board_init_f 函数的直接链接" title="board_init_f 函数的直接链接">​</a></h4><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token keyword" style="color:rgb(86, 156, 214)">void</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">board_init_f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">ulong boot_flags</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">//这段没有定义</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">ifdef</span><span class="token macro property"> </span><span class="token macro property expression">CONFIG_SYS_GENERIC_GLOBAL_DATA</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">/*</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     * For some archtectures, global data is initialized and used before</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     * calling this function. The data should be preserved. For others,</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     * CONFIG_SYS_GENERIC_GLOBAL_DATA should be defined and use the stack</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     * here to host global data until relocation.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token class-name" style="color:rgb(78, 201, 176)">gd_t</span><span class="token plain"> data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    gd </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&amp;</span><span class="token plain">data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">/*</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     * Clear global data before it is accessed at debug print</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     * in initcall_run_list. Otherwise the debug print probably</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     * get the wrong vaule of gd-&gt;have_console.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">zero_global_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    gd</span><span class="token operator" style="color:rgb(212, 212, 212)">-&gt;</span><span class="token plain">flags </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> boot_flags</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token comment" style="color:rgb(106, 153, 85)">//初始化=0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    gd</span><span class="token operator" style="color:rgb(212, 212, 212)">-&gt;</span><span class="token plain">have_console </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">0</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token comment" style="color:rgb(106, 153, 85)">//初始化序列init_sequence_f里的一些函数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token keyword" style="color:rgb(86, 156, 214)">if</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token function" style="color:rgb(220, 220, 170)">initcall_run_list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token plain">init_sequence_f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token function" style="color:rgb(220, 220, 170)">hang</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">if</span><span class="token macro property"> </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">!</span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">defined</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">CONFIG_ARM</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression"> </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">&amp;&amp;</span><span class="token macro property expression"> </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">!</span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">defined</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">CONFIG_SANDBOX</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token macro property expression"> </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">&amp;&amp;</span><span class="token macro property expression"> </span><span class="token macro property punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token macro property"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token macro property">        </span><span class="token macro property expression operator" style="color:rgb(212, 212, 212)">!</span><span class="token macro property expression function" style="color:rgb(220, 220, 170)">defined</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token macro property expression">CONFIG_EFI_APP</span><span class="token macro property expression punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">/* NOTREACHED - jump_to_copy() does not return */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">hang</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token macro property directive-hash">#</span><span class="token macro property directive keyword" style="color:rgb(86, 156, 214)">endif</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">/* Light up LED1 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token function" style="color:rgb(220, 220, 170)">imx6_light_up_led1</span><span class="token punctuation" style="color:rgb(212, 212, 212)">(</span><span class="token punctuation" style="color:rgb(212, 212, 212)">)</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>去掉条件编译以后的 init_sequence_f </p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">/*****************去掉条件编译语句后的 init_sequence_f***************/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token keyword" style="color:rgb(86, 156, 214)">static</span><span class="token plain"> </span><span class="token class-name" style="color:rgb(78, 201, 176)">init_fnc_t</span><span class="token plain"> init_sequence_f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      setup_mon_len</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">//=gd-&gt;mon_len __bss_end-_start=代码长度</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      initf_malloc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">//设置gd-&gt;malloc_limit=CONFIG_SYS_MALLOC_F_LEN=0X400 malloc_limit 表示 malloc 内存池大小。</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      initf_console_record</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      arch_cpu_init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">      </span><span class="token comment" style="color:rgb(106, 153, 85)">/* basic arch cpu dependent setup */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      initf_dm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">//驱动模型的一些初始化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      arch_cpu_init_dm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      mark_bootstage</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">     </span><span class="token comment" style="color:rgb(106, 153, 85)">/* need timer, go after init dm   */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      board_early_init_f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">   </span><span class="token comment" style="color:rgb(106, 153, 85)">//板子初期初始化，比如串口波特率</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     timer_init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">        </span><span class="token comment" style="color:rgb(106, 153, 85)">/* initialize timer*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     board_postclk_init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">//设置VDDSOC电压</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     get_clocks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">//获取的是 sdhc_clk 时钟，也就是SD卡外设的时钟</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     env_init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">          </span><span class="token comment" style="color:rgb(106, 153, 85)">/* initialize environment */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     init_baud_rate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">     </span><span class="token comment" style="color:rgb(106, 153, 85)">/* initialze baudrate settings    */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     serial_init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">       </span><span class="token comment" style="color:rgb(106, 153, 85)">/* serial communications setup    */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     console_init_f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">/* stage 1 init of console*/</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     display_options</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">    </span><span class="token comment" style="color:rgb(106, 153, 85)">/* say that we are here */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     display_text_info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">/* show debugging info if required */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token comment" style="color:rgb(106, 153, 85)">//如果开启debug会显示：debug(&quot;U-Boot code: %08lX -&gt; %08lX  BSS: -&gt; %08lX\n&quot;,text_base, bss_start, bss_end);</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     print_cpuinfo</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">      </span><span class="token comment" style="color:rgb(106, 153, 85)">/* display cpu info (and speed)   */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     show_board_info</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     INIT_FUNC_WATCHDOG_INIT   </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     INIT_FUNC_WATCHDOG_RESET</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     init_func_i2c</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     announce_dram_init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">/* TODO: unify all these dram functions? */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     dram_init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">     </span><span class="token comment" style="color:rgb(106, 153, 85)">/* configure available RAM banks */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     post_init_f</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     INIT_FUNC_WATCHDOG_RESET</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     testdram</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     INIT_FUNC_WATCHDOG_RESET</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     INIT_FUNC_WATCHDOG_RESET</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     </span><span class="token comment" style="color:rgb(106, 153, 85)">/* Now that we have DRAM mapped and working, we can</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     * relocate the code and continue running from DRAM.</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     *</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     * Reserve memory at end of RAM for (top down in that order):</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     * - area that won&#x27;t get touched by U-Boot and Linux (optional)</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     * - kernel log buffer</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     * - protected RAM</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     * - LCD framebuffer</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     * - monitor code</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     * - board info struct</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)">     */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    setup_dest_addr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token comment" style="color:rgb(106, 153, 85)">//设置目的地址，设置 gd-&gt;ram_size，gd-&gt;ram_top，gd-&gt;relocaddr</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    reserve_round_4k</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token comment" style="color:rgb(106, 153, 85)">//用于对gd-&gt;relocaddr做4KB对齐，因为gd-&gt;relocaddr=0XA0000000，已经是  4K 对齐了，所以调整后不变</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    reserve_mmu</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token comment" style="color:rgb(106, 153, 85)">//留出MMU的TLB表的位置，分配MMU的TLB表内存以后会对 gd-&gt;relocaddr 做 64K 字节对齐</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)">/*gd-&gt;arch.tlb_size= 0X4000                   //MMU 的  TLB 表大小</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> gd-&gt;arch.tlb_addr=0X9FFF0000           //MMU 的  TLB 表起始地址，64KB 对齐以后 </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token comment" style="color:rgb(106, 153, 85)"> gd-&gt;relocaddr=0X9FFF0000                 //relocaddr 地址 */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">     </span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    reserve_trace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token comment" style="color:rgb(106, 153, 85)">//留出跟踪调试的内存</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    reserve_uboot</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token comment" style="color:rgb(106, 153, 85)">//留出重定位后的 uboot 所占用的内存区域，uboot 所占用大小由gd-&gt;mon_len 所指定，留出 uboot 的空间以后还要对 gd-&gt;relocaddr 做 4K 字节对齐，并且重新设置 gd-&gt;start_addr_sp</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    reserve_malloc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token comment" style="color:rgb(106, 153, 85)">//留出 malloc 区域，调整 gd-&gt;start_addr_sp 位置</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    reserve_board</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    setup_machine</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain">  </span><span class="token comment" style="color:rgb(106, 153, 85)">//没用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    reserve_global_data</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token comment" style="color:rgb(106, 153, 85)">//设置newgd在DRAM里</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    reserve_fdt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token comment" style="color:rgb(106, 153, 85)">//设备树</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    reserve_arch</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    reserve_stacks</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    setup_dram_config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    show_dram_config</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    display_new_sp</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    INIT_FUNC_WATCHDOG_RESET</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    reloc_fdt</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    setup_reloc</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token constant" style="color:rgb(100, 102, 149)">NULL</span><span class="token punctuation" style="color:rgb(212, 212, 212)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><ol><li><p>初始化一系列外设 比如 串口、定时器、或者打印一些消息</p></li><li><p>初始化gd成员变量，</p></li><li><p>uboot 会将自己重定位到 DRAM 最后面的地址区域，也就是将自己拷贝到 DRAM <strong>最后面</strong>的内存区域中。这么做的目的是给 Linux 腾出空间，<strong>防止 Linux kernel 覆盖掉</strong> uboot，将 DRAM 前面的区域完整的空出来。在拷贝之前肯定要给 uboot 各部分分配好内存位置和大小，比如 gd 应该存放到哪个位置，<strong>malloc 内存池应该存放到哪个位置</strong>等等。这些信息都保存在 gd 的成员变量中，因此要对 gd 的这些成员变量做初始化。最终形成一个完整的内存“分配图”，在后面重定位 uboot 的时候就会用到这个内存“分配图”。</p><p>how?</p></li></ol><p>比较难理解的是<code>gd-&gt;relocaddr</code>，</p></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/zdyzlinuxarch"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">I.MX6U学习笔记裸机篇</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/zdyzlinuxsys2"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">I.MX6U学习笔记系统移植篇2</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#wtf-is-uboot" class="table-of-contents__link toc-highlight">WTF is Uboot</a><ul><li><a href="#uboot获取" class="table-of-contents__link toc-highlight">Uboot获取</a></li><li><a href="#uboot编译" class="table-of-contents__link toc-highlight">Uboot编译</a></li><li><a href="#uboot-makefile讲解" class="table-of-contents__link toc-highlight">Uboot Makefile讲解</a><ul><li><a href="#u-boot顶层makefile分析" class="table-of-contents__link toc-highlight">U-Boot顶层Makefile分析</a></li><li><a href="#命令输出" class="table-of-contents__link toc-highlight">命令输出</a></li><li><a href="#静默输出" class="table-of-contents__link toc-highlight">静默输出</a></li><li><a href="#设置编译结果输出目录" class="table-of-contents__link toc-highlight">设置编译结果输出目录</a></li><li><a href="#代码检查" class="table-of-contents__link toc-highlight">代码检查</a></li><li><a href="#模块编译" class="table-of-contents__link toc-highlight">模块编译</a></li><li><a href="#获取主机架构和系统" class="table-of-contents__link toc-highlight">获取主机架构和系统</a></li><li><a href="#设置目标架构交叉编译器配置文件" class="table-of-contents__link toc-highlight">设置目标架构、交叉编译器、配置文件</a></li><li><a href="#调用scriptskbuildinclude" class="table-of-contents__link toc-highlight">调用scripts/Kbuild.include</a></li><li><a href="#交叉编译工具变量设置" class="table-of-contents__link toc-highlight">交叉编译工具变量设置</a></li><li><a href="#导出其他变量" class="table-of-contents__link toc-highlight">导出其他变量</a></li><li><a href="#make-xxx_defconfig过程" class="table-of-contents__link toc-highlight">make xxx_defconfig过程</a></li></ul></li><li><a href="#u-bootbin怎么生成" class="table-of-contents__link toc-highlight">u-boot.bin怎么生成</a><ul><li><a href="#默认目标" class="table-of-contents__link toc-highlight">默认目标</a></li><li><a href="#链接" class="table-of-contents__link toc-highlight">链接</a></li><li><a href="#summary" class="table-of-contents__link toc-highlight">summary</a></li></ul></li><li><a href="#uboot启动流程" class="table-of-contents__link toc-highlight">Uboot启动流程</a><ul><li><a href="#u-bootlds" class="table-of-contents__link toc-highlight">u-boot.lds</a></li><li><a href="#函数" class="table-of-contents__link toc-highlight">函数</a></li><li><a href="#board_init_f-函数" class="table-of-contents__link toc-highlight">board_init_f 函数</a></li></ul></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">学习</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/tags">标签</a></li><li class="footer__item"><a class="footer__link-item" href="/archive">归档</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/skill">技术笔记</a></li><li class="footer__item"><a class="footer__link-item" href="/project">实战项目</a></li></ul></div><div class="col footer__col"><div class="footer__title">社交媒体</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/about">关于我</a></li><li class="footer__item"><a href="https://github.com/pansyhou" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" position="right" href="/friends">友链</a></li><li class="footer__item"><a class="footer__link-item" position="right" href="/resource">导航</a></li><li class="footer__item"><a href="https://docusaurus.io/zh-CN/" target="_blank"><img style="height:50px;margin-top:0.5rem" src="/img/buildwith.png"><a></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><p>Copyright © 2020 - PRESENT pansyhou Built with Docusaurus.</p></div></div></div></footer></div>
<script src="/assets/js/runtime~main.b6668888.js"></script>
<script src="/assets/js/main.0bce34a8.js"></script>
</body>
</html>